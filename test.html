<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="css/darkTheme.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    
    <div class="timeline" id="timeline"></div>
    
    <script type="module">
        import randomUseragent from 'https://cdn.jsdelivr.net/npm/random-useragent@0.5.0/+esm';
    </script>
    
    <script>
        function extractGitHubInfo(url) {
            const parts = url.split('/');
            const username = parts[parts.length - 2];
            const repo = parts[parts.length - 1];
            return { username, repo };
        }

        // Function to update repository based on input URL
        function updateRepo() {
            const repositoryURL = document.getElementById('repository').value;
            const { username, repo } = extractGitHubInfo(repositoryURL);
            if (username && repo) {
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set('url', repositoryURL);
                window.history.replaceState({}, '', `${window.location.pathname}?${urlParams.toString()}`);
                fetchCommits(username, repo);
            } else {
                document.querySelector('.error').textContent = 'Invalid GitHub Repository URL';
            }
        }

        // Function to fetch commits from GitHub
        function fetchCommits(username, repo) {
            const headers = new Headers();

            const defaultUserAgent = navigator.userAgent;
            let useragent = defaultUserAgent;

            headers.append('User-Agent', useragent);

            fetch(`https://api.github.com/repos/${username}/${repo}/commits`, {
                headers: headers
            })
                .then(response => {
                    if (!response.ok) {
                        useragent = randomUseragent.getRandom();

                        headers.set('User-Agent', useragent);
                        return fetch(`https://api.github.com/repos/${username}/${repo}/commits`, {
                            headers: headers
                        });
                    }
                    return response.json();
                })
                .then(commits => {
                    constructCommitTimeline(commits, repo);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }

        // Function to construct timeline items for commits
        function constructCommitTimeline(commits, repo) {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = ''; // Clear existing content

            const title = document.createElement('h1');
            const error = document.createElement('p');

            error.className = 'error';
            title.className = 'title';

            title.textContent = repo;

            if (Array.isArray(commits)) {
                commits.forEach((commit, index) => {
                    const container = document.createElement('div');
                    container.className = index % 2 === 0 ? 'container left' : 'container right';

                    const content = document.createElement('div');
                    content.className = 'content';

                    // Extracting commit message and timestamp
                    const message = commit.commit.message;
                    const timestamp = new Date(commit.commit.author.date).toLocaleString(); // Format timestamp

                    // Constructing content with message and timestamp
                    const messageParagraph = document.createElement('p');
                    messageParagraph.className = 'messageText';
                    messageParagraph.textContent = message;

                    const timestampParagraph = document.createElement('p');
                    timestampParagraph.className = 'timestampText';
                    timestampParagraph.textContent = timestamp;

                    content.appendChild(messageParagraph);
                    content.appendChild(timestampParagraph);

                    container.appendChild(content);
                    timeline.appendChild(container);
                });
            } else {
                error.textContent = 'No commits found';
                timeline.appendChild(error);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const repositoryURL = urlParams.get('url');
            if (repositoryURL) {
                const { username, repo } = extractGitHubInfo(repositoryURL);
                if (username && repo) {
                    fetchCommits(username, repo);
                } else {
                    document.querySelector('.error').textContent = 'Invalid GitHub Repository URL';
                }
            }
        });
    </script>
</body>
</html>